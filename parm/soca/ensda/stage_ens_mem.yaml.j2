######################################
# set some variables
######################################
{% set gPDY = previous_cycle | to_YMD %}
{% set gcyc = previous_cycle | strftime("%H") %}
{% set PDY = current_cycle | to_YMD %}
{% set cyc = current_cycle | strftime("%H") %}
######################################
# create working directories
######################################
mkdir:
- "{{ DATA }}/ens"

######################################
# copy ensemble background files
######################################
copy:
{% for mem in range(1, NMEM_ENS + 1) %}
    # define variables used in the history template
    {% set tmpl_dict = {'ROTDIR':ROTDIR,
                        'RUN': GDUMP_ENS,
                        'YMD':gPDY,
                        'HH':gcyc,
                        'MEMDIR':"mem" + '%03d' % mem} %}
    {% set com_prev_ocn = namespace(COM_OCEAN_HISTORY_MEM = COM_OCEAN_HISTORY_TMPL) %}
    {% set com_prev_ice = namespace(COM_ICE_HISTORY_MEM = COM_ICE_HISTORY_TMPL) %}
    {% for key in tmpl_dict.keys() %}
        {% set search_term = '${' + key + '}' %}
        {% set replace_term = tmpl_dict[key] %}
        {% set com_prev_ocn.COM_OCEAN_HISTORY_MEM = com_prev_ocn.COM_OCEAN_HISTORY_MEM.replace(search_term, replace_term) %}
        {% set com_prev_ice.COM_ICE_HISTORY_MEM = com_prev_ice.COM_ICE_HISTORY_MEM.replace(search_term, replace_term) %}
    {% endfor %}
    - ["{{ com_prev_ocn.COM_OCEAN_HISTORY_MEM }}/{{ GDUMP_ENS }}.ocean.t{{ gcyc }}z.inst.f006.nc", "{{ DATA }}/ens/ocean.{{ mem }}.nc"]
    - ["{{ com_prev_ice.COM_ICE_HISTORY_MEM }}/{{ GDUMP_ENS }}.ice.t{{ gcyc }}z.inst.f006.nc", "{{ DATA }}/ens/ice.{{ mem }}.nc"]
{% endfor %}
