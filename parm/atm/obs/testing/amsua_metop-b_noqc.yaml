obs operator:
  name: CRTM
  Absorbers: [H2O,O3]
  Clouds: [Water, Ice]
  Cloud_Fraction: 1.0
  obs options:
    Sensor_ID: &Sensor_ID amsua_metop-b
    EndianType: little_endian
    CoefficientPath: crtm/
obs space:
  name: amsua_metop-b
  obsdatain:
      engine:
        type: H5File
        obsfile: !ENV amsua_metop-b_obs_${CDATE}.nc4
  obsdataout:
      engine:
        type: H5File
        obsfile: !ENV amsua_metop-b_diag_${CDATE}.nc4
  simulated variables: [brightnessTemperature]
  channels: &amsua_metop-b_channels 1-15
geovals:
  filename: !ENV amsua_metop-b_geoval_${CDATE}.nc4
obs bias:
  input file: !ENV amsua_metop-b_satbias_${GDATE}.nc4
  variational bc:
    predictors:
    - name: constant
    - name: lapse_rate
      order: 2
      tlapse: &amsua_metop-b_tlap !ENV amsua_metop-b_tlapmean_${GDATE}.txt
    - name: lapse_rate
      tlapse: *amsua_metop-b_tlap
    - name: emissivity
    - name: scan_angle
      order: 4
    - name: scan_angle
      order: 3
    - name: scan_angle
      order: 2
    - name: scan_angle

obs post filters: 
# Step 0-B: Calculate derived variables
# Calculate CLW retrieved from observation 
- filter: Variable Assignment
  assignments: 
  - name: DerivedMetaData/CLWRetFromObs
    type: float
    function: 
      name: ObsFunction/CLWRetMW
      options:
        clwret_ch238: 1
        clwret_ch314: 2
        clwret_types: [ObsValue]

# Calculate CLW retrieved from background 
- filter: Variable Assignment 
  assignments:
  - name: DerivedMetaData/CLWRetFromBkg
    type: float
    function: 
      name: ObsFunction/CLWRetMW
      options:
        clwret_ch238: 1
        clwret_ch314: 2
        clwret_types: [HofX]

# Calculate symmetric retrieved CLW
- filter: Variable Assignment
  assignments:
  - name: DerivedMetaData/CLWRetSymmetric
    type: float
    value: 1000.0

- filter: Variable Assignment
  where:
  - variable:
      name: DerivedMetaData/CLWRetFromObs
    minvalue:   0. 
    maxvalue: 999. 
  - variable:
      name: DerivedMetaData/CLWRetFromBkg
    minvalue:   0. 
    maxvalue: 999. 
  where operator: and
  assignments:
  - name: DerivedMetaData/CLWRetSymmetric
    type: float
    function:
      name: ObsFunction/Arithmetic
      options:
        variables:
        - name: DerivedMetaData/CLWRetFromObs  
        - name: DerivedMetaData/CLWRetFromBkg  
        total coefficient: 0.5

# Calculate symmetric observation error 
- filter: Variable Assignment
  assignments:
  - name: DerivedMetaData/InitialObsError
    channels: *amsua_metop-b_channels
    type: float
    function:
      name: ObsFunction/ObsErrorModelRamp
      channels: *amsua_metop-b_channels
      options:
        channels: *amsua_metop-b_channels
        xvar:
          name: DerivedMetaData/CLWRetSymmetric
        x0:    [ 0.050,  0.030,  0.030,  0.020,  0.000,
                 0.100,  0.000,  0.000,  0.000,  0.000,
                 0.000,  0.000,  0.000,  0.000,  0.030]
        x1:    [ 0.600,  0.450,  0.400,  0.450,  1.000,
                 1.500,  0.000,  0.000,  0.000,  0.000,
                 0.000,  0.000,  0.000,  0.000,  0.200]
        err0:  [ 2.500,  2.200,  2.000,  0.550,  0.300,
                 0.230,  0.230,  0.250,  0.250,  0.350,
                 0.400,  0.550,  0.800,  4.000,  3.500]
        err1:  [20.000, 18.000, 12.000,  3.000,  0.500,
                 0.300,  0.230,  0.250,  0.250,  0.350,
                 0.400,  0.550,  0.800,  4.000, 18.000]

# Step 1: Assign initial all-sky observation error
- filter: Perform Action
  filter variables:
  - name: brightnessTemperature 
    channels: *amsua_metop-b_channels
  action: 
    name: assign error
    error function: 
      name: DerivedMetaData/InitialObsError
      channels: *amsua_metop-b_channels

passedBenchmark: 124549 
#vector ref: GsiHofXBc
#tolerance: 1.e-7
